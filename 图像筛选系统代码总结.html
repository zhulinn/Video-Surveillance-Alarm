<!DOCTYPE html>
<html class="theme theme-white">
<head>
<meta charset="utf-8">
<title>图像筛选系统代码总结</title>
<link href="https://www.zybuluo.com/static/assets/template-theme-white.css" rel="stylesheet" media="screen">
<style type="text/css">

#wmd-preview h1  {
    color: #0077bb; /* 将标题改为蓝色 */
}</style>
</head>
<body class="theme theme-white">
<div id="wmd-preview" class="wmd-preview wmd-preview-full-reader"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 id="图像筛选系统代码总结" data-anchor-id="dfr1">图像筛选系统代码总结</h1><p data-anchor-id="yquq"><code>深度学习</code></p><hr><div class="md-section-divider"></div><pre style="" data-anchor-id="mk2n" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># -*- coding: utf-8 -*-</span></code></li><li class="L1"><code class="language-python"><span class="str">"""</span></code></li><li class="L2"><code class="language-python"><span class="str">Created on Thu May 19 13:47:38 2016</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="str">@author: root</span></code></li><li class="L5"><code class="language-python"><span class="str">"""</span></code></li><li class="L6"><code class="language-python"><span class="com">#</span></code></li><li class="L7"><code class="language-python"><span class="com"># 本模块用于图像自主筛选系统</span></code></li><li class="L8"><code class="language-python"><span class="com"># 开发平台为 Jetson TK1 + ubuntu14.04</span></code></li><li class="L9"><code class="language-python"><span class="com"># 软件平台为 cuda6.5 + python2 + spyder</span></code></li><li class="L0"><code class="language-python"><span class="com"># 本模块基于Alexnet深度卷积神经网络提取图像深层次特征</span></code></li><li class="L1"><code class="language-python"><span class="com"># 并基于OMP的稀疏重构算法使用图像深度特征进行图像自主筛选</span></code></li><li class="L2"><code class="language-python"><span class="com"># 筛选后的图像由网络端口发送</span></code></li><li class="L3"><code class="language-python"><span class="com"># 流程图如下：</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="com">#       深度卷积神经网络初始化</span></code></li><li class="L6"><code class="language-python"><span class="com">#       图像库初始化</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="com">#       图像自主筛选系统分三个阶段</span></code></li><li class="L9"><code class="language-python"><span class="com">#       第一个阶段自系统开始运行开始</span></code></li><li class="L0"><code class="language-python"><span class="com">#       至图像库满10张图像结束</span></code></li><li class="L1"><code class="language-python"><span class="com">#       包括图像采集-&gt;特征提取-&gt;添加入库</span></code></li><li class="L2"><code class="language-python"><span class="com">#       三个步骤循环进行</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="com">#       第二个阶段自图像库满10张图像开始，至图像库满30张图像结束</span></code></li><li class="L5"><code class="language-python"><span class="com">#       包括图像采集-&gt;特征提取-&gt;稀疏重构判断-&gt;图像入库并发送或丢弃</span></code></li><li class="L6"><code class="language-python"><span class="com">#       四个过程循环进行</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="com">#       第三个阶段自图像库满30张图像开始</span></code></li><li class="L9"><code class="language-python"><span class="com">#       包括图像采集-&gt;特征提取-&gt;稀疏重构判断-&gt;图像入库并发送或丢弃-&gt;库更新</span></code></li><li class="L0"><code class="language-python"><span class="com">#       五个过程循环进行</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="kwd">import</span><span class="pln"> os</span></code></li><li class="L3"><code class="language-python"><span class="kwd">import</span><span class="pln"> numpy </span><span class="kwd">as</span><span class="pln"> np</span></code></li><li class="L4"><code class="language-python"><span class="kwd">import</span><span class="pln"> matplotlib</span><span class="pun">.</span><span class="pln">pyplot </span><span class="kwd">as</span><span class="pln"> plt</span></code></li><li class="L5"><code class="language-python"><span class="kwd">import</span><span class="pln"> find_caffe</span></code></li><li class="L6"><code class="language-python"><span class="kwd">import</span><span class="pln"> caffe</span></code></li><li class="L7"><code class="language-python"><span class="kwd">from</span><span class="pln"> sklearn</span><span class="pun">.</span><span class="pln">preprocessing </span><span class="kwd">import</span><span class="pln"> normalize</span></code></li><li class="L8"><code class="language-python"><span class="kwd">from</span><span class="pln"> sklearn</span><span class="pun">.</span><span class="pln">linear_model </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">OrthogonalMatchingPursuit</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="com"># 定义图像库类</span></code></li><li class="L1"><code class="language-python"><span class="com"># 图像库类包含数据与方法</span></code></li><li class="L2"><code class="language-python"><span class="kwd">class</span><span class="pln"> image_data_repo</span><span class="pun">:</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="kwd">def</span><span class="pln"> __init__</span><span class="pun">(</span><span class="pln">self</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">=</span><span class="str">'image_'</span><span class="pun">,</span><span class="pln"> image_feature_dict</span><span class="pun">={},</span><span class="pln"> reconsitution_element_nums</span><span class="pun">=</span><span class="lit">4</span><span class="pun">,</span><span class="pln"> error_limit</span><span class="pun">=</span><span class="lit">0.1</span><span class="pun">):</span></code></li><li class="L4"><code class="language-python"><span class="pln">        </span><span class="com"># 图像库名称</span></code></li><li class="L5"><code class="language-python"><span class="pln">        self</span><span class="pun">.</span><span class="pln">name </span><span class="pun">=</span><span class="pln"> name</span></code></li><li class="L6"><code class="language-python"><span class="pln">        </span><span class="com"># 图像库，按照键值对{图像名: 图像深度特征}存储图像与特征</span></code></li><li class="L7"><code class="language-python"><span class="pln">        self</span><span class="pun">.</span><span class="pln">image_feature_dict </span><span class="pun">=</span><span class="pln"> image_feature_dict</span><span class="pun">.</span><span class="pln">copy</span><span class="pun">()</span></code></li><li class="L8"><code class="language-python"><span class="pln">        </span><span class="com"># 最大参与稀疏重构元素个数</span></code></li><li class="L9"><code class="language-python"><span class="pln">        self</span><span class="pun">.</span><span class="pln">reconsitution_element_nums</span><span class="pun">=</span><span class="pln">reconsitution_element_nums</span></code></li><li class="L0"><code class="language-python"><span class="pln">        </span><span class="com"># 重构误差阈值</span></code></li><li class="L1"><code class="language-python"><span class="pln">        self</span><span class="pun">.</span><span class="pln">error_limit</span><span class="pun">=</span><span class="pln">error_limit</span></code></li><li class="L2"><code class="language-python"><span class="pln">        </span><span class="com"># 继承自 sklearn.linear_model.OrthogonalMatchingPursuit</span></code></li><li class="L3"><code class="language-python"><span class="pln">        self</span><span class="pun">.</span><span class="pln">omp</span><span class="pun">=</span><span class="typ">OrthogonalMatchingPursuit</span><span class="pun">(</span><span class="pln">n_nonzero_coefs</span><span class="pun">=</span><span class="pln">reconsitution_element_nums</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="kwd">def</span><span class="pln"> image_nums</span><span class="pun">(</span><span class="pln">self</span><span class="pun">):</span></code></li><li class="L5"><code class="language-python"><span class="pln">        </span><span class="com"># 返回图像库中图像数量</span></code></li><li class="L6"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">size</span><span class="pun">(</span><span class="pln">self</span><span class="pun">.</span><span class="pln">image_feature_dict</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="kwd">def</span><span class="pln"> add_element</span><span class="pun">(</span><span class="pln">self</span><span class="pun">,</span><span class="pln"> image_file_name</span><span class="pun">,</span><span class="pln"> feature</span><span class="pun">):</span></code></li><li class="L8"><code class="language-python"><span class="pln">        </span><span class="com"># 添加键值对{图像名: 图像深度特征}</span></code></li><li class="L9"><code class="language-python"><span class="pln">        self</span><span class="pun">.</span><span class="pln">image_feature_dict</span><span class="pun">[</span><span class="pln">image_file_name</span><span class="pun">]=</span><span class="pln">feature</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">def</span><span class="pln"> use_image</span><span class="pun">(</span><span class="pln">self</span><span class="pun">,</span><span class="pln"> image_feature</span><span class="pun">):</span></code></li><li class="L1"><code class="language-python"><span class="pln">        </span><span class="com"># 对输入特征进行稀疏重构，并与阈值对比，判断图像是否保留</span></code></li><li class="L2"><code class="language-python"><span class="pln">        </span><span class="com"># 转换输入特征为numpy.array格式</span></code></li><li class="L3"><code class="language-python"><span class="pln">        data </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">array</span><span class="pun">(</span><span class="pln">self</span><span class="pun">.</span><span class="pln">image_feature_dict</span><span class="pun">.</span><span class="pln">values</span><span class="pun">()).</span><span class="pln">T</span></code></li><li class="L4"><code class="language-python"><span class="pln">        </span><span class="com"># 使用OMP算法稀疏重构</span></code></li><li class="L5"><code class="language-python"><span class="pln">        self</span><span class="pun">.</span><span class="pln">omp</span><span class="pun">.</span><span class="pln">fit</span><span class="pun">(</span><span class="pln">data</span><span class="pun">,</span><span class="pln"> image_feature</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">        </span><span class="com"># 计算重构误差</span></code></li><li class="L7"><code class="language-python"><span class="pln">        err </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> self</span><span class="pun">.</span><span class="pln">omp</span><span class="pun">.</span><span class="pln">score</span><span class="pun">(</span><span class="pln">data</span><span class="pun">,</span><span class="pln"> image_feature</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> err</span><span class="pun">&gt;</span><span class="pln">self</span><span class="pun">.</span><span class="pln">error_limit</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="kwd">def</span><span class="pln"> update</span><span class="pun">(</span><span class="pln">self</span><span class="pun">):</span></code></li><li class="L0"><code class="language-python"><span class="pln">        </span><span class="com"># 库更新算法：对图像库中的每一张图像，计算与其他图像的相似度的最大值，作为图像与图像库的相似度</span></code></li><li class="L1"><code class="language-python"><span class="pln">        </span><span class="com">#               丢弃与图像库相似程度最大的图像</span></code></li><li class="L2"><code class="language-python"><span class="pln">        </span><span class="com"># 转换字典为列表</span></code></li><li class="L3"><code class="language-python"><span class="pln">        image_list </span><span class="pun">=</span><span class="pln"> self</span><span class="pun">.</span><span class="pln">image_feature_dict</span><span class="pun">.</span><span class="pln">items</span><span class="pun">()</span></code></li><li class="L4"><code class="language-python"><span class="pln">        </span><span class="com"># 列表解析</span></code></li><li class="L5"><code class="language-python"><span class="pln">        data </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">array</span><span class="pun">([</span><span class="pln">i</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> i </span><span class="kwd">in</span><span class="pln"> image_list</span><span class="pun">])</span></code></li><li class="L6"><code class="language-python"><span class="pln">        name </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">i</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> i </span><span class="kwd">in</span><span class="pln"> image_list</span><span class="pun">]</span></code></li><li class="L7"><code class="language-python"><span class="pln">        </span><span class="com"># 相似度列表</span></code></li><li class="L8"><code class="language-python"><span class="pln">        similar_coef </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">amax</span><span class="pun">(</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">dot</span><span class="pun">(</span><span class="pln">data</span><span class="pun">.</span><span class="pln">T</span><span class="pun">,</span><span class="pln">data</span><span class="pun">))</span></code></li><li class="L9"><code class="language-python"><span class="pln">        </span><span class="com"># 库更新</span></code></li><li class="L0"><code class="language-python"><span class="pln">        self</span><span class="pun">.</span><span class="pln">image_feature_dict</span><span class="pun">.</span><span class="pln">pop</span><span class="pun">(</span><span class="pln"> name</span><span class="pun">[</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">argmax</span><span class="pun">(</span><span class="pln"> similar_coef </span><span class="pun">)])</span><span class="pln">     </span></code></li><li class="L1"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="kwd">def</span><span class="pln"> send_image</span><span class="pun">(</span><span class="pln">image</span><span class="pun">):</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="com">#TODO</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln">         </span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="kwd">def</span><span class="pln"> caffe_init</span><span class="pun">():</span></code></li><li class="L8"><code class="language-python"><span class="pln">    </span><span class="com"># caffe初始化，没什么好说的</span></code></li><li class="L9"><code class="language-python"><span class="pln">    caffe</span><span class="pun">.</span><span class="pln">set_mode_gpu</span><span class="pun">()</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pln">    model_def </span><span class="pun">=</span><span class="pln"> </span><span class="str">'/home/ubuntu/caffe/models/bvlc_reference_caffenet/deploy_one_image.prototxt'</span></code></li><li class="L2"><code class="language-python"><span class="pln">    model_weights </span><span class="pun">=</span><span class="pln"> </span><span class="str">'/home/ubuntu/caffe/models/bvlc_reference_caffenet/bvlc_reference_caffenet.caffemodel'</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">    net </span><span class="pun">=</span><span class="pln"> caffe</span><span class="pun">.</span><span class="typ">Net</span><span class="pun">(</span><span class="pln">model_def</span><span class="pun">,</span><span class="pln">      </span><span class="com"># defines the structure of the model</span></code></li><li class="L5"><code class="language-python"><span class="pln">                    model_weights</span><span class="pun">,</span><span class="pln">  </span><span class="com"># contains the trained weights</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pln">                    caffe</span><span class="pun">.</span><span class="pln">TEST</span><span class="pun">)</span><span class="pln">     </span><span class="com"># use test mode (e.g., don't perform dropout)</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="com"># load the mean ImageNet image (as distributed with Caffe) for subtractiond</span></code></li><li class="L0"><code class="language-python"><span class="pln">    mu </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">load</span><span class="pun">(</span><span class="str">'./python/caffe/imagenet/ilsvrc_2012_mean.npy'</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">    mu </span><span class="pun">=</span><span class="pln"> mu</span><span class="pun">.</span><span class="pln">mean</span><span class="pun">(</span><span class="lit">1</span><span class="pun">).</span><span class="pln">mean</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span><span class="pln">  </span><span class="com"># average over pixels to obtain the mean (BGR) pixel values</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="com">#print 'mean-subtracted values:', zip('BGR', mu)</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="com"># create transformer for the input called 'data'</span></code></li><li class="L5"><code class="language-python"><span class="pln">    transformer </span><span class="pun">=</span><span class="pln"> caffe</span><span class="pun">.</span><span class="pln">io</span><span class="pun">.</span><span class="typ">Transformer</span><span class="pun">({</span><span class="str">'data'</span><span class="pun">:</span><span class="pln"> net</span><span class="pun">.</span><span class="pln">blobs</span><span class="pun">[</span><span class="str">'data'</span><span class="pun">].</span><span class="pln">data</span><span class="pun">.</span><span class="pln">shape</span><span class="pun">})</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pln">    transformer</span><span class="pun">.</span><span class="pln">set_transpose</span><span class="pun">(</span><span class="str">'data'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">(</span><span class="lit">2</span><span class="pun">,</span><span class="lit">0</span><span class="pun">,</span><span class="lit">1</span><span class="pun">))</span><span class="pln">  </span><span class="com"># move image channels to outermost dimension</span></code></li><li class="L8"><code class="language-python"><span class="pln">    transformer</span><span class="pun">.</span><span class="pln">set_mean</span><span class="pun">(</span><span class="str">'data'</span><span class="pun">,</span><span class="pln"> mu</span><span class="pun">)</span><span class="pln">            </span><span class="com"># subtract the dataset-mean value in each channel</span></code></li><li class="L9"><code class="language-python"><span class="pln">    transformer</span><span class="pun">.</span><span class="pln">set_raw_scale</span><span class="pun">(</span><span class="str">'data'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">255</span><span class="pun">)</span><span class="pln">      </span><span class="com"># rescale from [0, 1] to [0, 255]</span></code></li><li class="L0"><code class="language-python"><span class="pln">    transformer</span><span class="pun">.</span><span class="pln">set_channel_swap</span><span class="pun">(</span><span class="str">'data'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">(</span><span class="lit">2</span><span class="pun">,</span><span class="lit">1</span><span class="pun">,</span><span class="lit">0</span><span class="pun">))</span><span class="pln">  </span><span class="com"># swap channels from RGB to BGR</span></code></li><li class="L1"><code class="language-python"><span class="pln">    net</span><span class="pun">.</span><span class="pln">blobs</span><span class="pun">[</span><span class="str">'data'</span><span class="pun">].</span><span class="pln">reshape</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln">        </span><span class="com"># batch size</span></code></li><li class="L2"><code class="language-python"><span class="pln">                              </span><span class="lit">3</span><span class="pun">,</span><span class="pln">         </span><span class="com"># 3-channel (BGR) images</span></code></li><li class="L3"><code class="language-python"><span class="pln">                              </span><span class="lit">227</span><span class="pun">,</span><span class="pln"> </span><span class="lit">227</span><span class="pun">)</span><span class="pln">  </span><span class="com"># image size is 227x227</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> net</span><span class="pun">,</span><span class="pln">transformer</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="kwd">def</span><span class="pln"> get_feature</span><span class="pun">(</span><span class="pln">net</span><span class="pun">,</span><span class="pln">transformer</span><span class="pun">,</span><span class="pln">image</span><span class="pun">):</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="com"># 提取图像特征，进行2范数归一化</span></code></li><li class="L8"><code class="language-python"><span class="pln">    transformed_image </span><span class="pun">=</span><span class="pln"> transformer</span><span class="pun">.</span><span class="pln">preprocess</span><span class="pun">(</span><span class="str">'data'</span><span class="pun">,</span><span class="pln"> image</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="com">#plt.imshow(image)</span></code></li><li class="L0"><code class="language-python"><span class="pln">    net</span><span class="pun">.</span><span class="pln">blobs</span><span class="pun">[</span><span class="str">'data'</span><span class="pun">].</span><span class="pln">data</span><span class="pun">[...]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> transformed_image</span></code></li><li class="L1"><code class="language-python"><span class="pln">    net</span><span class="pun">.</span><span class="pln">forward</span><span class="pun">()</span></code></li><li class="L2"><code class="language-python"><span class="pln">    feature </span><span class="pun">=</span><span class="pln"> net</span><span class="pun">.</span><span class="pln">blobs</span><span class="pun">[</span><span class="str">'fc6'</span><span class="pun">].</span><span class="pln">data</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> normalize</span><span class="pun">(</span><span class="pln">feature</span><span class="pun">).</span><span class="pln">reshape</span><span class="pun">(</span><span class="pln">feature</span><span class="pun">.</span><span class="pln">size</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="kwd">if</span><span class="pln"> __name__</span><span class="pun">==</span><span class="str">'__main__'</span><span class="pun">:</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="com"># 深度卷积神经网络初始化</span></code></li><li class="L7"><code class="language-python"><span class="pln">    net</span><span class="pun">,</span><span class="pln">transformer </span><span class="pun">=</span><span class="pln"> caffe_init</span><span class="pun">()</span><span class="pln">  </span></code></li><li class="L8"><code class="language-python"><span class="pln">    </span><span class="com"># 图像库初始化</span></code></li><li class="L9"><code class="language-python"><span class="pln">    image_pool </span><span class="pun">=</span><span class="pln"> image_data_repo</span><span class="pun">();</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="com"># 图像自主筛选系统分三个阶段</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="com"># 第一个阶段自系统开始运行开始</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="com"># 至图像库满10张图像结束</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="com"># 包括图像采集-&gt;特征提取-&gt;添加入库</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="com"># 三个步骤循环进行</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> i </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="lit">10</span><span class="pun">):</span></code></li><li class="L7"><code class="language-python"><span class="pln">        image_file_name </span><span class="pun">=</span><span class="pln"> </span><span class="str">"image_{}.jpg"</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">i</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">        </span><span class="com"># 图像采集</span></code></li><li class="L9"><code class="language-python"><span class="pln">        os</span><span class="pun">.</span><span class="pln">system</span><span class="pun">(</span><span class="str">'echo {0} | ~/caffe/get_image_from_usb_camera.sh'</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">image_file_name</span><span class="pun">))</span></code></li><li class="L0"><code class="language-python"><span class="pln">        image </span><span class="pun">=</span><span class="pln"> caffe</span><span class="pun">.</span><span class="pln">io</span><span class="pun">.</span><span class="pln">load_image</span><span class="pun">(</span><span class="pln">image_file_name</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">        </span><span class="com"># 特征提取</span></code></li><li class="L2"><code class="language-python"><span class="pln">        feature </span><span class="pun">=</span><span class="pln"> get_feature</span><span class="pun">(</span><span class="pln">net</span><span class="pun">,</span><span class="pln">transformer</span><span class="pun">,</span><span class="pln">image</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">        </span><span class="com"># 添加入库</span></code></li><li class="L4"><code class="language-python"><span class="pln">        image_pool</span><span class="pun">.</span><span class="pln">add_element</span><span class="pun">(</span><span class="pln">image_file_name</span><span class="pun">,</span><span class="pln"> feature</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="com"># 第二个阶段自图像库满10张图像开始，至图像库满30张图像结束</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="com"># 包括图像采集-&gt;特征提取-&gt;稀疏重构判断-&gt;图像入库并发送或丢弃</span></code></li><li class="L8"><code class="language-python"><span class="pln">    </span><span class="com"># 四个过程循环进行</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="kwd">while</span><span class="pln"> image_pool</span><span class="pun">.</span><span class="pln">image_nums</span><span class="pun">()&lt;</span><span class="lit">30</span><span class="pun">:</span></code></li><li class="L0"><code class="language-python"><span class="pln">        i</span><span class="pun">=</span><span class="pln">i</span><span class="pun">+</span><span class="lit">1</span></code></li><li class="L1"><code class="language-python"><span class="pln">        image_file_name </span><span class="pun">=</span><span class="pln"> </span><span class="str">"image_{}.jpg"</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">i</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">        </span><span class="com"># 图像采集</span></code></li><li class="L3"><code class="language-python"><span class="pln">        os</span><span class="pun">.</span><span class="pln">system</span><span class="pun">(</span><span class="str">'echo {0} | ~/caffe/get_image_from_usb_camera.sh'</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">image_file_name</span><span class="pun">))</span></code></li><li class="L4"><code class="language-python"><span class="pln">        image </span><span class="pun">=</span><span class="pln"> caffe</span><span class="pun">.</span><span class="pln">io</span><span class="pun">.</span><span class="pln">load_image</span><span class="pun">(</span><span class="pln">image_file_name</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">        </span><span class="com"># 特征提取</span></code></li><li class="L6"><code class="language-python"><span class="pln">        feature </span><span class="pun">=</span><span class="pln"> get_feature</span><span class="pun">(</span><span class="pln">net</span><span class="pun">,</span><span class="pln">transformer</span><span class="pun">,</span><span class="pln">image</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">        </span><span class="com"># 稀疏重构判断</span></code></li><li class="L8"><code class="language-python"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> image_pool</span><span class="pun">.</span><span class="pln">use_image</span><span class="pun">(</span><span class="pln">feature</span><span class="pun">):</span></code></li><li class="L9"><code class="language-python"><span class="pln">            </span><span class="com"># 图像入库</span></code></li><li class="L0"><code class="language-python"><span class="pln">            image_pool</span><span class="pun">.</span><span class="pln">add_element</span><span class="pun">(</span><span class="pln">image_file_name</span><span class="pun">,</span><span class="pln"> feature</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">            </span><span class="com"># 图像发送</span></code></li><li class="L2"><code class="language-python"><span class="pln">            send_image</span><span class="pun">(</span><span class="pln">image_file_name</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="com"># 第三个阶段自图像库满30张图像开始</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="com"># 包括图像采集-&gt;特征提取-&gt;稀疏重构判断-&gt;图像入库并发送或丢弃-&gt;库更新</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="com"># 五个过程循环进行</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="kwd">while</span><span class="pln"> </span><span class="lit">1</span><span class="pun">:</span></code></li><li class="L8"><code class="language-python"><span class="pln">        i</span><span class="pun">=</span><span class="pln">i</span><span class="pun">+</span><span class="lit">1</span></code></li><li class="L9"><code class="language-python"><span class="pln">        image_file_name </span><span class="pun">=</span><span class="pln"> </span><span class="str">"image_{}.jpg"</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">i</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="pln">        </span><span class="com"># 图像采集</span></code></li><li class="L1"><code class="language-python"><span class="pln">        os</span><span class="pun">.</span><span class="pln">system</span><span class="pun">(</span><span class="str">'echo {0} | ~/caffe/get_image_from_usb_camera.sh'</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">image_file_name</span><span class="pun">))</span></code></li><li class="L2"><code class="language-python"><span class="pln">        image </span><span class="pun">=</span><span class="pln"> caffe</span><span class="pun">.</span><span class="pln">io</span><span class="pun">.</span><span class="pln">load_image</span><span class="pun">(</span><span class="pln">image_file_name</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">        </span><span class="com"># 特征提取</span></code></li><li class="L4"><code class="language-python"><span class="pln">        feature </span><span class="pun">=</span><span class="pln"> get_feature</span><span class="pun">(</span><span class="pln">net</span><span class="pun">,</span><span class="pln">transformer</span><span class="pun">,</span><span class="pln">image</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">        </span><span class="com"># 稀疏重构判断</span></code></li><li class="L6"><code class="language-python"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> image_pool</span><span class="pun">.</span><span class="pln">use_image</span><span class="pun">(</span><span class="pln">feature</span><span class="pun">):</span></code></li><li class="L7"><code class="language-python"><span class="pln">            </span><span class="com"># 图像入库</span></code></li><li class="L8"><code class="language-python"><span class="pln">            image_pool</span><span class="pun">.</span><span class="pln">add_element</span><span class="pun">(</span><span class="pln">image_file_name</span><span class="pun">,</span><span class="pln"> feature</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">            </span><span class="com"># 图像发送</span></code></li><li class="L0"><code class="language-python"><span class="pln">            send_image</span><span class="pun">(</span><span class="pln">image_file_name</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">            </span><span class="com"># 图像库更新</span></code></li><li class="L2"><code class="language-python"><span class="pln">            image_pool</span><span class="pun">.</span><span class="pln">update</span><span class="pun">()</span></code></li><li class="L3"><code class="language-python"></code></li></ol></pre></div>
</body>
</html>